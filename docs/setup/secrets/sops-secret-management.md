# SOPS Secret Management

This project uses [Mozilla SOPS](https://github.com/mozilla/sops) with [age](https://github.com/FiloSottile/age) encryption for managing secrets in Git.

## Why SOPS?

- **Git-native**: Secrets stored encrypted in Git (no external service dependency)
- **Team-friendly**: No user limits, free forever
- **Simple**: Standard tools (age + sops), easy to audit
- **Secure**: Encrypted at rest, decrypted only when needed

## Prerequisites

Install required tools:

```bash
# macOS
brew install age sops

# Linux (Ubuntu/Debian)
sudo apt-get update
curl -LO https://github.com/FiloSottile/age/releases/latest/download/age-v1.1.1-linux-amd64.tar.gz
tar xzf age-v1.1.1-linux-amd64.tar.gz
sudo mv age/age age/age-keygen /usr/local/bin/
curl -LO https://github.com/mozilla/sops/releases/download/v3.8.1/sops-v3.8.1.linux.amd64
sudo mv sops-v3.8.1.linux.amd64 /usr/local/bin/sops
sudo chmod +x /usr/local/bin/sops

# Windows (using WSL - recommended)
# Install WSL first: wsl --install
# Then follow Linux instructions above inside WSL

# Windows (native - requires manual setup)
# 1. Install Git for Windows (includes Git Bash)
# 2. Download age.exe from: https://github.com/FiloSottile/age/releases
# 3. Download sops.exe from: https://github.com/mozilla/sops/releases
# 4. Add both to your PATH
# Note: Makefiles require Git Bash with make or WSL
#       pnpm scripts also use make underneath, so same requirement applies
```

## Team Onboarding

### 1. Get the Age Secret Key

**New team members**: Ask an existing team member to securely share the age secret key.

**Secret key location**: The key should be shared via a secure channel

### 2. Save the Age Key Locally

```bash
# Create the age key file in the project root
cd /path/to/ninja
echo "AGE-SECRET-KEY-xxxxxxxxxx" > .age-key.txt
chmod 600 .age-key.txt
```

⚠️ **NEVER commit .age-key.txt** - it's in .gitignore

### 3. Set Environment Variable

Add to your shell profile (`~/.zshrc`, `~/.bashrc`, etc.):

```bash
# SOPS age key for ninja project
export SOPS_AGE_KEY_FILE=/path/to/ninja/.age-key.txt
```

Then reload your shell or run `source ~/.zshrc`

### 4. Decrypt Secrets for Local Development

```bash
# Using Makefile (macOS/Linux/WSL)
make decrypt-local      # Decrypts to .env for local development
make decrypt-staging    # Decrypts to .env.staging
make decrypt-production # Decrypts to .env.production

# Using pnpm (works everywhere, including Windows Git Bash)
pnpm secrets:decrypt              # Decrypts to .env for local development
pnpm secrets:decrypt:staging      # Decrypts to .env.staging
pnpm secrets:decrypt:production   # Decrypts to .env.production
```

## Daily Workflow

### View/Edit Secrets

```bash
# Using Makefile (macOS/Linux/WSL)
make edit-local        # Edit local secrets (opens in nano, auto-encrypts on save)
make edit-staging      # Edit staging secrets
make edit-production   # Edit production secrets

# Using pnpm (works everywhere, including Windows Git Bash)
pnpm secrets:edit              # Edit local secrets
pnpm secrets:edit:staging      # Edit staging secrets
pnpm secrets:edit:production   # Edit production secrets

# Change editor (default is nano)
EDITOR=vim make edit-local
EDITOR=code make edit-staging  # VS Code (waits for window to close)
```

### Decrypt for Local Use

```bash
# Using Makefile
make decrypt-local      # Generate .env from encrypted secrets
make decrypt-staging    # Generate .env.staging from encrypted secrets
make decrypt-production # Generate .env.production from encrypted secrets

# Using pnpm (recommended for Windows)
pnpm secrets:decrypt              # Generate .env
pnpm secrets:decrypt:staging      # Generate .env.staging
pnpm secrets:decrypt:production   # Generate .env.production
```

### After Editing Encrypted Files

When you edit secrets using `make edit-staging` or `pnpm secrets:edit:staging`, SOPS automatically:
1. Decrypts the file
2. Opens it in nano (or your preferred editor)
3. Re-encrypts it when you save and exit

Just commit the changes:

```bash
git add secrets/staging.enc.yaml
git commit -m "Update staging secrets"
git push
```

**Nano Quick Tips:**
- Save: `Ctrl+O`, then `Enter`
- Exit: `Ctrl+X`
- If prompted to save: `Y` then `Enter`

## File Structure

```
ninja/
├── .age-key.txt              # Local only (gitignored) - your decryption key
├── .sops.yaml                # SOPS config (committed) - defines encryption rules
├── secrets/
│   ├── local.enc.yaml        # Encrypted local/dev secrets (committed)
│   ├── staging.enc.yaml      # Encrypted staging secrets (committed)
│   └── production.enc.yaml   # Encrypted production secrets (committed)
├── .env                      # Decrypted (gitignored) - generated by `make decrypt-local`
├── .env.staging              # Decrypted (gitignored) - generated by `make decrypt-staging`
└── .env.production           # Decrypted (gitignored) - generated by `make decrypt-production`
```

## CI/CD Setup

### GitHub Actions

Add `SOPS_AGE_KEY` to GitHub Secrets:
1. Go to repo Settings → Secrets and variables → Actions
2. Add new secret: `SOPS_AGE_KEY`
3. Value: `AGE-SECRET-KEY-1ESL5AN0DT78YJNL6Z67KXZC3V5UAZQQ6D4HQ23X7ES2CDG7H8SNQKR8WT9`

Workflow example:

```yaml
- name: Install SOPS
  run: |
    sudo apt-get update && sudo apt-get install -y age
    curl -LO https://github.com/mozilla/sops/releases/download/v3.8.1/sops-v3.8.1.linux.amd64
    sudo mv sops-v3.8.1.linux.amd64 /usr/local/bin/sops
    sudo chmod +x /usr/local/bin/sops

- name: Decrypt Secrets
  env:
    SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
  run: |
    echo "$SOPS_AGE_KEY" > .age-key.txt
    export SOPS_AGE_KEY_FILE=.age-key.txt
    pnpm secrets:decrypt:staging  # or pnpm secrets:decrypt:production
```

## Windows Users

**Recommended: Use WSL (Windows Subsystem for Linux)**
- Install WSL: `wsl --install` in PowerShell (admin)
- Clone repo inside WSL: `cd ~; git clone ...`
- Follow Linux instructions above
- Access files from Windows: `\\wsl$\Ubuntu\home\youruser\ninja`
- All commands (make, pnpm scripts, nano) work perfectly

**Alternative: Git Bash (requires make installation)**
- Install Git for Windows (comes with Git Bash)
- Install make: Download from [ezwinports](https://sourceforge.net/projects/ezwinports/files/make-4.3-without-guile-w32-bin.zip)
- Extract and add to PATH
- Download age.exe and sops.exe from GitHub releases
- Both `make` and `pnpm` commands will work
- Install nano: `pacman -S nano` in Git Bash (if using mingw64)

**PowerShell Direct Method (manual)**
```powershell
# Set environment variable
$env:SOPS_AGE_KEY_FILE = ".age-key.txt"

# Decrypt manually (no make/pnpm needed)
sops -d secrets\staging.enc.yaml | ForEach-Object {
  if ($_ -match '^(.+): (.+)$') {
    "$($matches[1])=$($matches[2])"
  }
} | Out-File -Encoding utf8 .env.staging

# Edit secrets (opens in notepad)
$env:EDITOR = "notepad"
sops secrets\staging.enc.yaml
```

**Bottom Line for Windows:**
- **Easy way**: Use WSL (everything just works)
- **Hard way**: Install make + nano for Git Bash
- **Manual way**: Use PowerShell commands directly

## Security Notes

### What's Safe to Commit
✅ `secrets/*.enc.yaml` - Encrypted secrets
✅ `.sops.yaml` - SOPS configuration
✅ Age **public** key (in .sops.yaml)

### NEVER Commit
❌ `.age-key.txt` - Secret decryption key
❌ `.env*` files - Decrypted secrets
❌ Age **secret** key (AGE-SECRET-KEY-...)

### Key Rotation

If the age key is compromised:

1. Generate new key: `age-keygen -o .age-key-new.txt`
2. Update `.sops.yaml` with new public key
3. Re-encrypt all files: `make encrypt-all`
4. Share new secret key with team
5. Update GitHub Secrets
6. Delete old key

## Troubleshooting

### "error loading config: no matching creation rules"
- Ensure you're in the project root
- Check that `.sops.yaml` exists
- Verify file path matches regex in `.sops.yaml`

### "failed to get the data key required to decrypt"
- Wrong age key or missing `SOPS_AGE_KEY_FILE`
- Run `export SOPS_AGE_KEY_FILE=/path/to/.age-key.txt`

### "no such file or directory: .age-key.txt"
- Get the secret key from a team member
- Save it to `.age-key.txt` in project root

## Manual Commands

If you prefer not to use Makefile or pnpm scripts:

```bash
# Decrypt and view
sops -d secrets/staging.enc.yaml

# Edit (decrypt → edit → encrypt)
EDITOR=nano sops secrets/staging.enc.yaml

# Decrypt to .env format (macOS/Linux)
sops -d secrets/staging.enc.yaml | awk -F': ' '{
  key = $1
  value = substr($0, index($0, ": ") + 2)
  if (value ~ /^".*"$/) {
    gsub(/^"|"$/, "", value)
    if (value ~ / / || value == "" || value ~ /^[0-9]+$/) {
      print key"=\""value"\""
    } else {
      print key"="value
    }
  } else if (value ~ / /) {
    print key"=\""value"\""
  } else {
    print key"="value
  }
}' > .env.staging

# Windows PowerShell
sops -d secrets\staging.enc.yaml | ForEach-Object {
  if ($_ -match '^(.+): (.+)$') {
    "$($matches[1])=$($matches[2])"
  }
} | Out-File -Encoding utf8 .env.staging
```

## Reference

- **Age Public Key**: `age1t8uvd9nppt3fcdgtzajlwmcwh0dntdk7axvshkvq5hsjrkv2rc6shhlgg9`
- **Age Secret Key**: Ask team lead (stored securely, not in Git)
- [SOPS Documentation](https://github.com/mozilla/sops)
- [Age Documentation](https://github.com/FiloSottile/age)
